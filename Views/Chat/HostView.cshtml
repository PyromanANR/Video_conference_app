<div class="container">
    <h1 class="mt-5 mb-0">VideoChat</h1>
</div>

<div id="chatSection" style="display: none;">
    <div>
        <label>Enter your name:</label>
        <input type="text" id="userInput" class="form-control"/>
    </div>
    <div>
        <label>Enter a message:</label>
        <input type="text" id="messageInput" class="form-control"/>
        <button id="sendButton" class="btn btn-primary">Send</button>
    </div>
    <div id="videoContainer"></div>
    <ul id="messagesList" class="list-group mt-3"></ul>
</div>

<div class="container text-center fixed-bottom mb-3">
    <div class="row">
        <div class="col">
            <button id="copyButton" class="btn btn-primary mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy mr-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
                </svg>
                Copy Link
            </button>
        </div>
        <div class="col">
            <button id="chatButton" class="btn btn-success mb-3">Chat</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
            document.addEventListener('DOMContentLoaded', function() {
                var copyButton = document.getElementById('copyButton');
                copyButton.addEventListener('click', function () {
                    var chatLink = window.location.href;
    
                    navigator.clipboard.writeText(chatLink)
                        .then(function() {
                            alert('Link copied to clipboard!');
                        })
                        .catch(function(err) {
                            console.error('Failed to copy link: ', err);
                            alert('Failed to copy link to clipboard.');
                        });
                });
            });
        </script>


    <script>
    const chatButton = document.getElementById("chatButton");
    const chatSection = document.getElementById("chatSection");
    
    chatButton.addEventListener("click", function() {
        if (chatSection.style.display === "none") {
            chatSection.style.display = "block";
        } else {
            chatSection.style.display = "none";
        }
    });
    </script>

    <script>
        const roomId = "@ViewBag.RoomId";
        let userId = null;
        
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        const myPeer = new Peer();

        myPeer.on('open', id => {
            userId = id;
            
             connection.start()
            .then(() => {
                connection.invoke("JoinRoom", roomId, userId);

            })
            .catch(err => console.error(err.toString()));
        });    

        window.addEventListener('beforeunload', () => {
            connection.invoke("LeaveRoom", roomId);
        });

        connection.on("ReceiveMessage", (user, message) => {
            const messageElement = document.createElement("li");
            messageElement.textContent = `${user}: ${message}`;
            document.getElementById("messagesList").appendChild(messageElement);
        });
        
        connection.on("ReceiveMessageHistory", messages => {
            const messagesList = document.getElementById("messagesList");
            messages.forEach(message => {
                const messageElement = document.createElement("li");
                messageElement.textContent = message;
                messagesList.appendChild(messageElement);
            });
        });

        connection.on("UpdateMicrophoneStatus", (user, isMicrophoneEnabled) => {
            let currentUser = document.getElementById("userInput").value; 
            if (user === currentUser) { 
                const microphoneIndicator = document.getElementById("microphoneIndicator");
                microphoneIndicator.style.backgroundColor = isMicrophoneEnabled ? "green" : "gray";
            }
        });

        document.getElementById("sendButton").addEventListener("click", () => {
            const message = document.getElementById("messageInput").value;
            const user = document.getElementById("userInput").value;
            connection.invoke("SendMessage", roomId, user, message);
            document.getElementById("messageInput").value = "";
        });


        let isMicrophoneEnabled = false; 

        document.getElementById("toggleMicrophoneButton").addEventListener("click", () => {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then((stream) => {
                    const audioTrack = stream.getTracks()[0];
                    isMicrophoneEnabled = !isMicrophoneEnabled; 
                    audioTrack.enabled = isMicrophoneEnabled; 
                    const user = document.getElementById("userInput").value;
                    connection.invoke("ToggleMicrophone", roomId, user, isMicrophoneEnabled);
                })
                .catch((error) => {
                    console.error("Error accessing microphone:", error);
                });
        });

        let peerConnections = {};

        document.getElementById("shareVideoButton").addEventListener("click", async () => {
            const user = document.getElementById("userInput").value;

            const videoElement = document.createElement("video");
            videoElement.id = `video-${user}`;
            document.getElementById("videoContainer").appendChild(videoElement);

            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    const videoElement = document.getElementById(`video-${user}`);
                    videoElement.srcObject = stream;

                    const peerConnection = new RTCPeerConnection();
                    peerConnections[user] = peerConnection;
                    stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            connection.invoke("SendIceCandidate", roomId, user, event.candidate);
                        }
                    };

                    const offer = peerConnection.createOffer()
                        .then(offer => {
                            return peerConnection.setLocalDescription(offer);
                        })
                        .then(() => {
                            connection.invoke("SendOffer", roomId, user, peerConnection.localDescription);
                        });
                })
                .catch((error) => {
                    console.error("Error accessing video:", error);
                });
        });


        connection.on("ReceiveOffer", (user, offer) => {
            peerConnections[user].setRemoteDescription(new RTCSessionDescription(offer));
            const answer = peerConnections[user].createAnswer();
            peerConnections[user].setLocalDescription(answer);
            connection.invoke("SendAnswer", roomId, user, answer);
        });

        connection.on("ReceiveAnswer", (user, answer) => {
            peerConnections[user].setRemoteDescription(new RTCSessionDescription(answer));
        });

        connection.on("ReceiveIceCandidate", (user, candidate) => {
            peerConnections[user].addIceCandidate(new RTCIceCandidate(candidate));
        });


        connection.start().catch(err => console.error(err.toString()));
    </script>
}